#!/usr/bin/env node

/**
 * Advanced Tool Chaining Demo
 * 
 * This script demonstrates the powerful chain tool capabilities
 * by running some example workflows.
 */

import { MCPHub } from '../src/MCPHub.js';
import { Marketplace } from '../src/marketplace.js';
import { ToolsetRegistry } from '../src/mcp/toolset-registry.js';

const DEMO_CONFIG = {
  mcpServers: {
    filesystem: {
      command: "npx",
      args: ["-y", "@modelcontextprotocol/server-filesystem", "/tmp"]
    },
    github: {
      command: "npx", 
      args: ["-y", "@modelcontextprotocol/server-github"],
      env: {
        GITHUB_PERSONAL_ACCESS_TOKEN: "demo_token"
      },
      disabled: true // Disabled for demo unless token provided
    }
  }
};

async function runDemo() {
  console.log("üöÄ Advanced Tool Chaining Demo\n");

  // Initialize MCP Hub
  const marketplace = new Marketplace();
  const hub = new MCPHub(DEMO_CONFIG, { port: 3001, marketplace });
  await hub.initialize();

  const registry = new ToolsetRegistry(hub, null);

  console.log("üìã Available Servers:");
  const servers = registry.listServers();
  servers.forEach(server => {
    console.log(`  - ${server.name} (${server.status})`);
  });
  console.log("");

  // Demo 1: Basic Sequential Chain
  console.log("üîó Demo 1: Basic Sequential Chain");
  console.log("Creating a file and then reading it back...");
  
  try {
    const basicChain = {
      chain: [
        {
          id: "create_file",
          server_name: "filesystem",
          tool_name: "write_file",
          arguments: {
            path: "/tmp/demo.txt",
            contents: "Hello from MCP Hub Advanced Chaining!"
          }
        },
        {
          id: "read_file",
          server_name: "filesystem", 
          tool_name: "read_file",
          input_mapping: {
            path: "create_file.result.path || '/tmp/demo.txt'"
          }
        }
      ]
    };

    console.log("Executing chain...");
    const result1 = await registry.chainTools(basicChain);
    console.log("‚úÖ Chain completed successfully!");
    console.log(`üìä Executed ${result1.executionSummary.executedSteps}/${result1.executionSummary.totalSteps} steps`);
    console.log(`‚è±Ô∏è  Total time: ${result1.executionSummary.elapsed}ms\n`);
  } catch (error) {
    console.log(`‚ùå Chain failed: ${error.message}\n`);
  }

  // Demo 2: Template Substitution and Variables
  console.log("üîó Demo 2: Template Substitution");
  console.log("Using variables and templates...");

  try {
    const templateChain = {
      variables: {
        timestamp: new Date().toISOString(),
        author: "demo-user",
        project: "mcp-hub"
      },
      chain: [
        {
          server_name: "filesystem",
          tool_name: "write_file",
          arguments: {
            path: "/tmp/{{VARS.project}}-report-{{VARS.timestamp}}.md",
            contents: `# {{VARS.project}} Report\n\nGenerated by: {{VARS.author}}\nTimestamp: {{VARS.timestamp}}\n\nThis is a demo of template substitution in advanced tool chaining.`
          }
        }
      ]
    };

    const result2 = await registry.chainTools(templateChain);
    console.log("‚úÖ Template chain completed!");
    console.log(`üìù File created with templated name and content\n`);
  } catch (error) {
    console.log(`‚ùå Template chain failed: ${error.message}\n`);
  }

  // Demo 3: Conditional Execution with Error Handling
  console.log("üîó Demo 3: Conditional Execution & Error Handling");
  console.log("Testing conditional execution and skip-on-error...");

  try {
    const conditionalChain = {
      chain: [
        {
          id: "check_file",
          server_name: "filesystem",
          tool_name: "read_file",
          arguments: { path: "/tmp/nonexistent.txt" },
          conditions: {
            skip_on_error: true
          }
        },
        {
          id: "fallback_create",
          server_name: "filesystem",
          tool_name: "write_file",
          conditions: {
            execute_if: "check_file.result.isError"
          },
          arguments: {
            path: "/tmp/fallback.txt",
            contents: "Created because original file didn't exist"
          }
        }
      ]
    };

    const result3 = await registry.chainTools(conditionalChain);
    console.log("‚úÖ Conditional chain completed!");
    console.log(`üîÑ Executed ${result3.chainResults.filter(r => !r.skipped).length} steps (${result3.chainResults.filter(r => r.skipped).length} skipped)`);
    console.log(`üìä Error handling worked as expected\n`);
  } catch (error) {
    console.log(`‚ùå Conditional chain failed: ${error.message}\n`);
  }

  // Demo 4: Parallel Execution
  console.log("üîó Demo 4: Parallel Execution");
  console.log("Creating multiple files in parallel...");

  try {
    const parallelChain = {
      chain: [
        {
          id: "file1",
          server_name: "filesystem",
          tool_name: "write_file",
          parallel_group: "create_files",
          arguments: {
            path: "/tmp/parallel1.txt",
            contents: "File created in parallel - 1"
          }
        },
        {
          id: "file2", 
          server_name: "filesystem",
          tool_name: "write_file",
          parallel_group: "create_files",
          arguments: {
            path: "/tmp/parallel2.txt", 
            contents: "File created in parallel - 2"
          }
        },
        {
          id: "file3",
          server_name: "filesystem",
          tool_name: "write_file", 
          parallel_group: "create_files",
          arguments: {
            path: "/tmp/parallel3.txt",
            contents: "File created in parallel - 3"
          }
        },
        {
          id: "summary",
          server_name: "filesystem",
          tool_name: "write_file",
          arguments: {
            path: "/tmp/parallel_summary.txt",
            contents: "All parallel files created successfully!"
          }
        }
      ],
      execution_options: {
        max_parallel: 3
      }
    };

    const startTime = Date.now();
    const result4 = await registry.chainTools(parallelChain);
    const elapsed = Date.now() - startTime;
    
    console.log("‚úÖ Parallel chain completed!");
    console.log(`‚ö° Parallel groups: ${result4.executionSummary.parallelGroups}`);
    console.log(`‚è±Ô∏è  Total time: ${elapsed}ms (would be ~3x longer if sequential)\n`);
  } catch (error) {
    console.log(`‚ùå Parallel chain failed: ${error.message}\n`);
  }

  // Demo 5: Retry Logic
  console.log("üîó Demo 5: Retry Logic");
  console.log("Testing retry logic with a potentially failing operation...");

  try {
    const retryChain = {
      chain: [
        {
          server_name: "filesystem",
          tool_name: "read_file",
          arguments: { path: "/tmp/maybe_exists.txt" },
          retry: {
            max_attempts: 3,
            delay_ms: 500,
            backoff_multiplier: 2
          },
          conditions: {
            skip_on_error: true
          }
        },
        {
          server_name: "filesystem",
          tool_name: "write_file",
          arguments: {
            path: "/tmp/retry_demo.txt", 
            contents: "Retry logic demo completed!"
          }
        }
      ]
    };

    const result5 = await registry.chainTools(retryChain);
    console.log("‚úÖ Retry chain completed!");
    console.log(`üîÑ Chain handled failures gracefully with retry logic\n`);
  } catch (error) {
    console.log(`‚ùå Retry chain failed: ${error.message}\n`);
  }

  console.log("üéâ Advanced Tool Chaining Demo Complete!");
  console.log("\nKey Features Demonstrated:");
  console.log("- ‚úÖ Sequential execution with input mapping");
  console.log("- ‚úÖ Template substitution and variables");
  console.log("- ‚úÖ Conditional execution and error handling");
  console.log("- ‚úÖ Parallel execution for performance");
  console.log("- ‚úÖ Retry logic with exponential backoff");
  console.log("- ‚úÖ Comprehensive execution summaries");
  
  console.log("\nüìö For more examples, see:");
  console.log("   examples/advanced-tool-chaining.md");

  await hub.cleanup();
}

// Run the demo if this script is executed directly
if (import.meta.url === `file://${process.argv[1]}`) {
  runDemo().catch(console.error);
}

export { runDemo };
