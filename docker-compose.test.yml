version: '3.8'

networks:
  mcp-test-network:
    driver: bridge

services:
  init-data:
    image: busybox
    volumes:
      - mcp-hub-data:/data
    command: ['sh', '-c', 'chmod 777 /data && chown 1001:1001 /data']

  postgres:
    image: postgres:14-alpine
    container_name: mcp-postgres-test
    environment:
      POSTGRES_DB: mcp_hub
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: testpass123
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - mcp-test-network
    ports:
      - "15432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  mcp-hub:
    build: 
      context: .
      dockerfile: Dockerfile
    container_name: mcp-hub-test
    user: "1001:1001"
    init: true
    depends_on:
      init-data:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
    networks:
      - mcp-test-network
    ports:
      - "37375:37373"
    environment:
      - NODE_ENV=production
      - HOST=0.0.0.0
      - PORT=37373
      - ENABLE_POSTGRES=true
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=testpass123
      - POSTGRES_DB=mcp_hub
      - DATA_DIR=/app/data
    volumes:
      - ./config/mcp-servers.docker.json:/app/config/mcp-servers.json:ro
      - mcp-hub-data:/app/data
      - mcp-hub-logs:/app/logs
    restart: unless-stopped

volumes:
  postgres-data:
  mcp-hub-data:
  mcp-hub-logs:
